workflows:
  my-workflow:
    name: Build App
    instance_type: linux_x2
    max_build_duration: 60
    environment:
      flutter: 3.27.4
      vars:
        CM_SECRET: "ZW52aXJvbm1lbnQ6DQogIHZhcnM6DQogICAgQU5EUk9JRF9BUElfS0VZOiAiQUl6YVN5QnJwQWhPbS1La2dYMEIybFYxY2JWVHFFaHlkek54b0NJIg0KICAgIEZJUkVCQVNFX0FQSV9LRVk6ICJ5b3VyX2ZpcmViYXNlX2FwaV9rZXlfaGVyZSINCiAgICBGSVJFQkFTRV9BVVRIX0RPTUFJTjogIndoYXRzYXBwLWJhY2tlbmQtZjFhMjcuZmlyZWJhc2VhcHAuY29tIg0KICAgIEZJUkVCQVNFX1BST0pFQ1RfSUQ6ICJ3aGF0c2FwcC1iYWNrZW5kLWYxYTI3Ig0KICAgIEZJUkVCQVNFX1NUT1JBR0VfQlVDS0VUOiAid2hhdHNhcHAtYmFja2VuZC1mMWEyNy5hcHBzcG90LmNvbSINCiAgICBGSVJFQkFTRV9NRVNTQUdJTkdfU0VOREVSX0lEOiAiMjg0ODc5MDg4MjM2Ig0KICAgIEZJUkVCQVNFX0FQUF9JRDogIjE6Mjg0ODc5MDg4MjM2OmFuZHJvaWQ6NTYwYWQyZTRiMjI2YWEzMjg3ODY0OSINCiAgICBQQUNLQUdFX05BTUU6ICJjb20uZXhhbXBsZS53aGF0c2FwcCINCiAgICBBR09SQV9BUFBfSUQ6ICI2MTE1ZjgxZmQxNWY0NDU0OTU5ZmRmNDNkNDYxODliMiINCiAgICBBR09SQV9BUFBfQ0VSVElGSUNBVEU6ICJmZjJkMjdjZDk0NWQ0Y2E3OTNjNWJjZjZiOTIzMTU0ZSINCiAgICBHT09HTEVfU0VSVklDRV9KU09OOiAiQkFTRTY0X0VOQ09ERURfQ09OVEVOVF9PRl9HT09HTEVfU0VSVklDRVNfSlNPTiINCg0K"
        GOOGLE_SERVICES_JSON: "ewogICJwcm9qZWN0X2luZm8iOiB7CiAgICAicHJvamVjdF9udW1iZXIiOiAiMjg0ODc5MDg4MjM2IiwKICAgICJwcm9qZWN0X2lkIjogIndoYXRzYXBwLWJhY2tlbmQtZjFhMjciLAogICAgInN0b3JhZ2VfYnVja2V0IjogIndoYXRzYXBwLWJhY2tlbmQtZjFhMjcuYXBwc3BvdC5jb20iCiAgfSwKICAiY2xpZW50IjogWwogICAgewogICAgICAiY2xpZW50X2luZm8iOiB7CiAgICAgICAgIm1vYmlsZXNka19hcHBfaWQiOiAiMToyODQ4NzkwODgyMzY6YW5kcm9pZDphMTQxOTQ5YjM3ODkxYjZjODc4NjQ5IiwKICAgICAgICAiYW5kcm9pZF9jbGllbnRfaW5mbyI6IHsKICAgICAgICAgICJwYWNrYWdlX25hbWUiOiAiY29tLmV4YW1wbGUud2hhdHNhcHAiCiAgICAgICAgfQogICAgICB9LAogICAgICAib2F1dGhfY2xpZW50IjogW10sCiAgICAgICJhcGlfa2V5IjogWwogICAgICAgIHsKICAgICAgICAgICJjdXJyZW50X2tleSI6ICJBSXphU3lCcnBBaE9tLUtrZ1gwQjJsVjFjYlZUcUVoeWR6TnhvQ0kiCiAgICAgICAgfQogICAgICBdLAogICAgICAic2VydmljZXMiOiB7CiAgICAgICAgImFwcGludml0ZV9zZXJ2aWNlIjogewogICAgICAgICAgIm90aGVyX3BsYXRmb3JtX29hdXRoX2NsaWVudCI6IFtdCiAgICAgICAgfQogICAgICB9CiAgICB9CiAgXSwKICAiY29uZmlndXJhdGlvbl92ZXJzaW9uIjogIjEiCn0="
        GOOGLE_SERVICES_INFO_PLIST: "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPCFET0NUWVBFIHBsaXN0IFBVQkxJQyAiLS8vQXBwbGUvL0RURCBQTElTVCAxLjAvL0VOIiAiaHR0cDovL3d3dy5hcHBsZS5jb20vRFREcy9Qcm9wZXJ0eUxpc3QtMS4wLmR0ZCI+CjxwbGlzdCB2ZXJzaW9uPSIxLjAiPgo8ZGljdD4KCTxrZXk+QVBJX0tFWTwva2V5PgoJPHN0cmluZz5BSXphU3lCOUd4eFFMYW1UaDZYRk5TLTIwVXNkUnI1N2dvUzl2ZDQ8L3N0cmluZz4KCTxrZXk+R0NNX1NFTkRFUl9JRDwva2V5PgoJPHN0cmluZz4yODQ4NzkwODgyMzY8L3N0cmluZz4KCTxrZXk+UExJU1RfVkVSU0lPTjwva2V5PgoJPHN0cmluZz4xPC9zdHJpbmc+Cgk8a2V5PkJVTkRMRV9JRDwva2V5PgoJPHN0cmluZz5jb20uZXhhbXBsZS53aGF0c2FwcDwvc3RyaW5nPgoJPGtleT5QUk9KRUNUX0lEPC9rZXk+Cgk8c3RyaW5nPndoYXRzYXBwLWJhY2tlbmQtZjFhMjc8L3N0cmluZz4KCTxrZXk+U1RPUkFHRV9CVUNLRVQ8L2tleT4KCTxzdHJpbmc+d2hhdHNhcHAtYmFja2VuZC1mMWEyNy5hcHBzcG90LmNvbTwvc3RyaW5nPgoJPGtleT5JU19BRFNfRU5BQkxFRDwva2V5PgoJPGZhbHNlPjwvZmFsc2U+Cgk8a2V5PklTX0FOQUxZVElDU19FTkFCTEVEPC9rZXk+Cgk8ZmFsc2U+PC9mYWxzZT4KCTxrZXk+SVNfQVBQSU5WSVRFX0VOQUJMRUQ8L2tleT4KCTx0cnVlPjwvdHJ1ZT4KCTxrZXk+SVNfR0NNX0VOQUJMRUQ8L2tleT4KCTx0cnVlPjwvdHJ1ZT4KCTxrZXk+SVNfU0lHTklOX0VOQUJMRUQ8L2tleT4KCTx0cnVlPjwvdHJ1ZT4KCTxrZXk+R09PR0xFX0FQUF9JRDwva2V5PgoJPHN0cmluZz4xOjI4NDg3OTA4ODIzNjppb3M6OTA4NjkwMmVhN2RlYTk5ZDg3ODY0OTwvc3RyaW5nPgoJPGtleT5EQVRBQkFTRV9VUkw8L2tleT4KCTxzdHJpbmc+aHR0cHM6Ly93aGF0c2FwcC1iYWNrZW5kLWYxYTI3LWRlZmF1bHQtcnRkYi5ldXJvcGUtd2VzdDEuZmlyZWJhc2VkYXRhYmFzZS5hcHA8L3N0cmluZz4KPC9kaWN0Pgo8L3BsaXN0Pg=="
        # ... بقية المتغيرات

    scripts:
      - name: Get Flutter Dependencies
        script: flutter pub get

      - name: Create local.properties for Codemagic
        script: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > android/local.properties
          echo "flutter.sdk=$FLUTTER_ROOT" >> android/local.properties

      - name: Decode google-services.json
        script: |
          echo $GOOGLE_SERVICES_JSON | base64 --decode > android/app/google-services.json

      - name: Decode GoogleService-Info_plist
        script: |
          echo $GOOGLE_SERVICES_INFO.PLIST | base64 --decode > ios/Runner/GoogleService-Info.plist

      - name: Decode secrets
        script: echo $CM_SECRET | base64 --decode > codemagic.yaml.secret

      - name: Run Flutter Tests with Coverage
        script: flutter test --coverage

      - name: Build Android APK
        script: flutter build apk --release -v

    artifacts:
      - build/app/outputs/flutter-apk/app-release.apk
      - coverage/lcov.info    # رفع ملف التغطية لتتمكن من تحميله ومراجعته

    publishing:
      email:
        recipients:
          - ahmedali205001@gmail.com

